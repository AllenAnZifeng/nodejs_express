<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>home</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <link rel="icon" href="">
    <link rel="stylesheet" type="text/css" href="/static/stylesheets/home.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.min.css"
    />

    <script src="https://kit.fontawesome.com/6670bd51cb.js" crossorigin="anonymous"></script>
</head>

<body>
<div id="home">
    <div id="left">
        <div><b>
            <div id="name"></div>
        </b><span id="userID" class="hide"></span></div>
        <div id="search-container">
            <div id="cancel" class="hide" onclick="user.cancelOnClickListener()"><i class="fa fa-window-close"
                                                                                    aria-hidden="true"></i></div>
            <form method="post" id="searchFriendForm">
                <label for="search"></label>
                <input type="text" placeholder="Search for a friend..." name='search' id="search"
                       onfocus="user.focusEventListener()">
                <button type="submit"><i class="fa fa-search"></i></button>
            </form>
        </div>

        <div id="result" class="noDisplay">

        </div>


        <div id="friendContent">


            <div id="friendList">

            </div>
        </div>

        <div id="panel">
            <div id="logout" onclick="user.logout()"><i class="fas fa-sign-out-alt"></i></div>
            <div id="requestNotitification" onclick="user.displayFriendRequest()"><i class="far fa-comment"></i></div>
            <div id="requestContainer" class="noDisplay">
                <div id="requests"></div>
            </div>
        </div>


    </div>

    <div id="right">
        <div id="messageContent" class="hide">
            <div id="friendName"></div>
            <div id="history"></div>

            <div id="sendMessage">
                <div id="drag"></div>
                <label for="messageArea"></label>
                <textarea id="messageArea" name="messageArea" required></textarea>
                <div id="sendButton" onclick="user.sendListener()">Send</div>
            </div>

        </div>
    </div>


</div>
</body>

<script>
    const DOMAIN = 'http://127.0.0.1:8000';
    let messageArea = document.getElementById('messageArea');


    function User() {
        this.id = null;
        this.username = null;
        this.friends = [];
        this.message = [];
        this.selectedFriendID = null
        this.chatMessage = '';

        this.logout = () => {
            document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            window.location = DOMAIN + '/users/login/';
        };

        this.enableDragTextarea = () => {
            let dragDiv = document.getElementById('drag');
            let msgDiv = document.getElementById('sendMessage');

            let dragFunc = (event) => {
                // console.log(event.y, dragDiv.style.top);
                msgDiv.style.height = window.innerHeight - event.y + 'px';
            }
            let addMoveListener = () => {
                window.addEventListener("mousemove", dragFunc);
            }
            let removeMoveListener = () => {
                window.removeEventListener("mousemove", dragFunc);
            }

            dragDiv.addEventListener('mousedown', addMoveListener);
            window.addEventListener('mouseup', removeMoveListener);

        }

        this.displayFriendRequest = () => {
            document.getElementById('requestContainer').classList.toggle('noDisplay');
        };

        this.focusEventListener = () => {
            document.getElementsByName('search')[0].placeholder = '';
            document.getElementById('friendContent').classList.add('hide');
            document.getElementById('cancel').classList.remove('hide');
            document.getElementById('result').classList.remove('noDisplay');

        };

        this.cancelOnClickListener = () => {
            document.getElementById('search').value = '';
            document.getElementsByName('search')[0].placeholder = 'Search for a friend...';
            document.getElementById('friendContent').classList.remove('hide');
            document.getElementById('cancel').classList.add('hide');
            document.getElementById('result').classList.add('noDisplay');
        };

        this.updateChat = () => {

            let parent = document.getElementById('history');
            parent.innerHTML = '';

            for (let i = 0; i < this.message.length; i++) {
                if (this.message[i].ToID === this.id && this.message[i].FromID === this.selectedFriendID) {
                    let div = document.createElement('div');
                    div.innerText = this.message[i].Body;
                    div.classList.add('friendToMeMessage', 'message');
                    parent.appendChild(div);
                } else if (this.message[i].ToID === this.selectedFriendID && this.message[i].FromID === this.id) {
                    let div = document.createElement('div');
                    div.innerText = this.message[i].Body;
                    div.classList.add('meToFriendMessage', 'message');
                    parent.appendChild(div);
                }
            }


        };

        this.updateView = () => {
            if (this.selectedFriendID) {
                this.updateChat();
            }
        };


        this.friendClickListener = (id) => { // update history
            // console.log(id,this.selectedFriendID);
            if (this.selectedFriendID && id !== this.selectedFriendID) {
                document.getElementById(this.selectedFriendID).style.backgroundColor = '';
            }

            document.getElementById(id).style.backgroundColor = '#bbb';
            this.selectedFriendID = id;
            document.getElementById('friendName').innerText = document.getElementById(id).innerText;
            messageArea.focus();
            document.getElementById('messageContent').classList.remove('hide');

            this.updateChat();
            // this.chatScrollDown();

        };

        this.chatScrollDown = () => {
            let parent = document.getElementById('history');
            parent.scrollTo(0, parent.scrollHeight);
        }

        // this.responseMessage = (error, error_message,
        //                         redirect, message) => {
        //     return {
        //         'error': error,
        //         'error_message': error_message,
        //         'redirect': redirect,
        //         'message': message,
        //     }
        // }


        this.fetch = async (url, method, body = {}) => {

            return await new Promise(async (resolve, reject) => {
                setTimeout(() => {
                    reject(new Error('Timeout Error Fetch failed'));
                }, 3000);

                let response;
                if (method === 'GET') {
                    response = await fetch(DOMAIN + url, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json;charset=utf-8'
                        },
                    });
                } else {
                    response = await fetch(DOMAIN + url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json;charset=utf-8'
                        },
                        body: JSON.stringify(body)
                    });
                }
                let result = await response.json();
                resolve(result);

            }).catch(
                error => {
                    console.error(error);
                    return {'error': true, 'error_message': error, 'redirect': false, 'message': ''};
                }
            )


        };


        function Message(to, from, type, body = null) {

            this.json = {
                to: to,
                from: from,
                type: type,
                body: body,
            }

        }


        this.sendListener = async () => {
            let contentBody = this.chatMessage;
            console.log(contentBody);

            let message = new Message(this.selectedFriendID, this.id, 'message', contentBody);
            let response = await this.fetch('/message/', 'POST', message.json);

            if (response.error) {
                messageArea.placeholder = 'Send Failed';
            } else {
                this.chatMessage = '';
                messageArea.value = '';
                messageArea.placeholder = '';

            }
        };

        this.scrollDown = () =>{
            let history = document.getElementById('history');
            history.scrollTop = history.scrollHeight;

        }


        this.getUsername = async () => {
            let cookies = document.cookie.split('=');
            let token;
            for (let i = 0; i < cookies.length; i++) {
                if (cookies[i] === 'token') {
                    token = cookies[i + 1];
                    break;
                }
            }

            let response = await this.fetch('/cookieInfo/', 'GET');

            if (response.error) {
                console.log(response);
                alert('Parse Cookie Error!')
            } else {
                this.username = response.message.username;
                this.id = response.message.userID;
                document.getElementById('name').innerText = 'Hello, ' + this.username;
                document.getElementById('userID').innerText = this.id + '';
            }
        }


        this.getFriendRequest = async () => {

            let icon = document.getElementById('requestNotitification');

            let response = await this.fetch('/friendRequest/' + this.id + '/', 'GET');

            if (response.error) {
                icon.style.color = '';
                document.getElementById('requests').innerText = 'No friend requests yet.'
            } else {

                icon.style.color = '#ff5e00';
                icon.classList.toggle('animate__tada');
                icon.classList.toggle('animate__animated');
                // console.log(response);


                let temp = [];
                let innerHtml = '';
                for (let i = 0; i < response.message.length; i++) {
                    if (temp.includes(response.message[i].FromID)) {
                        continue
                    }
                    innerHtml += '<div class="request" id="request' + i + '">' + '<div>Friend request from ' + response.message[i].name + '</div><div>' + ' <i class="fa fa-check accept" id="accept' + i + '" aria-hidden="true"></i>&emsp;<i class="fa fa-times reject" id="reject' + i + '" aria-hidden="true"></i></div></div>'
                    temp.push(response.message[i].FromID);
                }
                document.getElementById('requests').innerHTML = innerHtml;

                for (let i = 0; i < response.message.length; i++) {
                    if (document.getElementById('accept' + i) === null) {
                        continue
                    }
                    document.getElementById('accept' + i).onclick = async () => {
                        document.getElementById('request' + i).style.display = 'none';
                        let res = await this.fetch('/friendRequest/accept/', 'POST', {
                            myID: response.message[i].ToID,
                            friendID: response.message[i].FromID
                        });
                        if (res.error) {
                            console.log(res.error_message);
                        }
                        // this.displayFriendRequest();


                    };
                    document.getElementById('reject' + i).onclick = async () => {
                        document.getElementById('request' + i).style.display = 'none';
                        let res = await this.fetch('/friendRequest/', 'DELETE', {
                            myID: response.message[i].ToID,
                            friendID: response.message[i].FromID
                        });
                        if (res.error) {
                            console.log(res.error_message);
                        }
                        // this.displayFriendRequest();

                    };
                }
            }
        };

        this.getFriendList = async () => {

            let response = await this.fetch('/friend/' + this.id + '/', 'GET');

            if (response.error) {
                console.error(response.error_message);
            } else {

                if (response.message.length === 0) {
                    this.friends = [];
                    document.getElementById('friendList').innerHTML = '<div id="noFriend">No Friends yet</div>';
                } else if (this.friends.length === 0) { // initialize for the first time
                    this.friends = response.message;
                    let html = '';
                    for (let i = 0; i < response.message.length; i++) {
                        html += '<div class="friend" id="' + response.message[i].friendID + '">' + response.message[i].name + '</div>'
                    }
                    document.getElementById('friendList').innerHTML = html;
                    for (let i = 0; i < response.message.length; i++) {
                        document.getElementById(response.message[i].friendID).onclick = () => {
                            this.friendClickListener(response.message[i].friendID);
                        }
                    }

                } else if (response.message.length > user.friends.length) { // new friend added
                    this.friends = response.message;
                    let html = '<div class="friend" id="' + response.message[response.message.length - 1].friendID + '">' + response.message[response.message.length - 1].name + '</div>';
                    document.getElementById('friendList').innerHTML += html;
                    document.getElementById(response.message[response.message.length - 1].friendID).onclick = () => {
                        this.friendClickListener(response.message[response.message.length - 1].friendID);
                    }
                }
            }
        };

        this.getMessageHistory = async () => {

            let response = await this.fetch('/message/' + this.id + '/', 'GET');
            if (response.error) {
                console.error(response.error_message)
            } else {
                this.message = response.message;
            }
        };

        this.initializeSearchField = () => {
            document.getElementById('searchFriendForm').onsubmit = async (e) => {
                e.preventDefault();

                let friendName = document.getElementById('search').value;

                let response = await this.fetch('/users/userID/' + friendName + '/', 'GET');

                let resultDisplay = document.getElementById('result');

                if (response.error) {
                    resultDisplay.innerHTML = '<span>User does not Exist!</span>';
                    // console.error(response.error_message);

                } else {
                    if (this.id !== response.message) {
                        resultDisplay.innerHTML = '<span>' + friendName + '</span>' + '<span style="cursor: pointer;margin-right: 3.5em" id="addButton">Add</span>';
                        let addButton = document.getElementById('addButton');
                        addButton.onclick = async () => {
                            addButton.onclick = null;
                            let message = new Message(response.message, this.id, 'request');
                            let result = await this.fetch('/friendRequest/', 'POST', message.json);

                            if (result.error) {
                                addButton.innerText = result.error_message;
                            } else {
                                addButton.style.color = 'red';
                                addButton.innerText = ' Pending';
                            }
                        };
                    } else {
                        resultDisplay.innerText = 'No Such User'
                    }
                }
            };
        };
    }

    document.addEventListener('keyup', (e) => {


        if (messageArea === document.activeElement && !(e.code === "Enter" || e.key === 'Enter' || e.which === 13)) {
                messageArea.placeholder = '';
                user.chatMessage = messageArea.value;
        }
    });


    document.addEventListener('keydown',(e)=>{
        if (messageArea === document.activeElement){
            if (e.shiftKey && e.code === "Enter"){
                    // new line in the text area
            }
            else if( e.code === "Enter" || e.key === 'Enter' || e.which === 13 && messageArea === document.activeElement) {
                e.preventDefault();
                console.log(user.chatMessage, user.chatMessage.length);

                user.chatMessage = user.chatMessage.trim();
                if (user.chatMessage.length === 0) {
                    messageArea.placeholder = 'Empty Body'
                    user.chatMessage='';
                    messageArea.value='';
                } else {
                    user.sendListener();
                }
            }
        }

    });


    async function main() {

        window.user = new User();

        user.initializeSearchField();
        user.enableDragTextarea();
        await user.getUsername();

        await user.getFriendRequest();
        await user.getFriendList();
        await user.getMessageHistory();

    }

    let slowLoop = async () => {

        await user.getFriendRequest();
        await user.getFriendList();
    };

    let fastLoop = async () => {
        await user.getMessageHistory();
        user.updateView();
    };

    main();
    setInterval(fastLoop, 500);
    setInterval(slowLoop, 2000);


</script>
</html>